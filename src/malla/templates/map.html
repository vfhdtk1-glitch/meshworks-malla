{% extends "base.html" %}
{% from "components/sidebar_macros.html" import sidebar_container, selected_details_section, search_section, controls_section, stats_section, legend_section, sidebar_styles %}

{% block title %}Node Map - Malla{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS (vendored) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.css') }}?v={{ STATIC_VERSION }}" />
<!-- Leaflet MarkerCluster CSS (vendored) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/MarkerCluster.css') }}?v={{ STATIC_VERSION }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/MarkerCluster.Default.css') }}?v={{ STATIC_VERSION }}" />
<!-- Page-specific and sidebar styles (moved from inline to satisfy CSP) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}?v={{ STATIC_VERSION }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}?v={{ STATIC_VERSION }}" />
{% endblock %}

{% block content %}
<!-- Override the base template's container to make this page full-width/full-height -->
</div> <!-- Close the base template's container -->

<div class="map-container">
    <!-- Main Map Area -->
    <div class="map-main">
        <div id="mapLoading" class="loading-overlay">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading node locations...</p>
        </div>
        <div id="map" class="network-map"></div>
        <div id="mapFallbackOverlay" class="map-fallback-overlay" hidden></div>
        <div id="mapError" class="error-overlay" style="display: none;">
            <i class="bi bi-exclamation-triangle"></i>
            <p class="mt-2">Error loading map data</p>
        </div>
    </div>

    <!-- Sidebar -->
    {% call sidebar_container("sidebar", "Network Map", "bi bi-map", "toggleSidebar") %}
        {{ selected_details_section("clearSelection") }}

        <!-- Node Search and List Combined -->
        <div class="sidebar-section">
            <h6><i class="bi bi-search"></i> Search & Filter Nodes</h6>
            <div class="input-group input-group-sm mb-2">
                <input type="text" class="form-control" id="nodeSearch" placeholder="Search by node name or ID...">
                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                    <i class="bi bi-x"></i>
                </button>
            </div>

            <!-- Combined search results and node list -->
            <div id="nodeListContainer" class="node-list-container">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Nodes (<span id="nodeCount">0</span>)</small>
                    <small class="text-muted" id="searchResultsCount" style="display: none;">
                        <span id="searchCount">0</span> results
                    </small>
                </div>
                <div id="nodeList" class="node-list">
                    <div class="text-center text-muted py-4">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 small">Loading nodes...</p>
                    </div>
                </div>
            </div>
        </div>

        {% set map_controls = [
            {"class": "btn-outline-secondary", "onclick": "fitMapToNodes()", "icon": "bi bi-arrows-move", "text": "Fit All Nodes"},
            {"class": "btn-outline-primary", "onclick": "refreshMap()", "icon": "bi bi-arrow-clockwise", "text": "Refresh"}
        ] %}
        {{ controls_section(map_controls) }}

        <!-- Filters -->
        <div class="sidebar-section">
            <h6><i class="bi bi-funnel"></i> Filters</h6>
            <form id="locationFilterForm">
                <div class="mb-3">
                    <label for="maxAge" class="form-label">Max Age</label>
                    <select class="form-select form-select-sm" id="maxAge" name="maxAge">
                        <option value="">No Limit</option>
                        <option value="1">1 Hour</option>
                        <option value="6">6 Hours</option>
                        <option value="24">24 Hours</option>
                        <option value="72">3 Days</option>
                        <option value="168">1 Week</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="roleFilter" class="form-label">Node Role</label>
                    <select class="form-select form-select-sm" id="roleFilter" name="roleFilter">
                        <option value="">All Roles</option>
                        <option value="CLIENT">Client</option>
                        <option value="ROUTER">Router</option>
                        <option value="ROUTER_LATE">Router Late</option>
                        <option value="REPEATER">Repeater</option>
                        <option value="CLIENT_MUTE">Client Mute</option>
                        <option value="ROUTER_CLIENT">Router Client</option>
                        <option value="SENSOR">Sensor</option>
                        <option value="UNKNOWN">Unknown/Other</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="channelFilter" class="form-label">Primary Channel</label>
                    <select class="form-select form-select-sm" id="channelFilter" name="channelFilter">
                        <option value="">All Channels</option>
                        <!-- Options loaded dynamically -->
                    </select>
                </div>
                <div class="mb-3">
                    <label for="startDateTime" class="form-label">Start Date & Time</label>
                    <input type="datetime-local" class="form-control form-control-sm" id="startDateTime" name="startDateTime">
                </div>
                <div class="mb-3">
                    <label for="endDateTime" class="form-label">End Date & Time</label>
                    <input type="datetime-local" class="form-control form-control-sm" id="endDateTime" name="endDateTime">
                </div>
                <div class="d-flex justify-content-end mb-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="clearDateRange">
                        <i class="bi bi-x-circle"></i> Clear Dates
                    </button>
                </div>
                <div class="mb-3">
                    <label for="minContacts" class="form-label">Min Contacts</label>
                    <input type="number" class="form-control form-control-sm" id="minContacts" name="minContacts" value="1" min="1">
                </div>
                <button type="submit" class="btn btn-primary btn-sm w-100">
                    <i class="bi bi-funnel"></i> Apply Filters
                </button>
            </form>
        </div>

        <!-- Map Stats -->
        <div class="sidebar-section">
            <h6><i class="bi bi-bar-chart"></i> Statistics</h6>
            <div id="mapStats" class="stats-content">
                <div><strong>Nodes:</strong> <span id="statsNodes">0</span></div>
                <div><strong>With Location:</strong> <span id="statsWithLocation">0</span></div>
                <div><strong>RF Links:</strong> <span id="statsLinks">0</span></div>
                <div><strong>Last Update:</strong> <span id="statsLastUpdate">--</span></div>
            </div>
        </div>

        <!-- Link visibility checkboxes -->
        <div class="sidebar-section">
            <h6><i class="bi bi-diagram-3"></i> Link Types</h6>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tracerouteLinksCheckbox" checked>
                <label class="form-check-label" for="tracerouteLinksCheckbox">Traceroute Links</label>
            </div>
            <div class="form-check mt-1">
                <input class="form-check-input" type="checkbox" id="packetLinksCheckbox">
                <label class="form-check-label" for="packetLinksCheckbox">Packet Links</label>
            </div>
        </div>

        <!-- Hop depth selector (shown only when a node is selected) -->
        <div class="sidebar-section" id="hopDepthSection" style="display: none;">
            <h6><i class="bi bi-stack"></i> Hop Depth</h6>
            <div class="small text-muted mb-2">Choose how many RF hops from the selected node remain visible.</div>
            <select class="form-select form-select-sm" id="hopDepthSelect">
                <option value="1" selected>1 hop</option>
                <option value="2">2 hops</option>
                <option value="3">3 hops</option>
                <option value="4">4 hops</option>
                <option value="5">5 hops</option>
                <option value="999">All</option>
            </select>
        </div>

        {% set map_legend_items = [
            {"type": "span", "class": "role-color-indicator", "style": "background-color: #007bff;", "content": "", "text": "Client"},
            {"type": "span", "class": "role-color-indicator", "style": "background-color: #28a745;", "content": "", "text": "Router"},
            {"type": "span", "class": "role-color-indicator", "style": "background-color: #28a745;", "content": "", "text": "Router Late"},
            {"type": "span", "class": "role-color-indicator", "style": "background-color: #ffc107;", "content": "", "text": "Repeater"},
            {"type": "span", "class": "role-color-indicator", "style": "background-color: #6c757d;", "content": "", "text": "Client Mute"},
            {"type": "span", "class": "role-color-indicator", "style": "background-color: #17a2b8;", "content": "", "text": "Router Client"},
            {"type": "span", "class": "role-color-indicator", "style": "background-color: #e83e8c;", "content": "", "text": "Sensor"},
            {"type": "span", "class": "role-color-indicator", "style": "background-color: #dc3545;", "content": "", "text": "Unknown Role"},
            {"type": "span", "class": "signal-indicator bg-success", "content": "", "text": "Excellent coverage"},
            {"type": "span", "class": "signal-indicator bg-warning", "content": "", "text": "Good coverage"},
            {"type": "span", "class": "signal-indicator bg-danger", "content": "", "text": "Limited coverage"},
            {"type": "span", "class": "legend-line", "style": "border-top: 4px solid #0d6efd;", "content": "", "text": "Traceroute link"},
            {"type": "span", "class": "legend-line", "style": "border-top: 4px dashed #0d6efd;", "content": "", "text": "Packet link"}
        ] %}
        {% call legend_section(map_legend_items) %}
            <div class="legend-item mt-2">
                <small class="text-muted">Node colors indicate role types<br>
                Click nodes for details<br>
                RF links show radio connections<br>
                Clusters group nearby nodes</small>
            </div>
        {% endcall %}
    {% endcall %}
</div>

{# Sidebar styles now provided via static css; inline removed for CSP #}

{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="{{ url_for('static', filename='js/leaflet.js') }}?v={{ STATIC_VERSION }}"></script>
<!-- Leaflet MarkerCluster JS -->
<script src="{{ url_for('static', filename='js/leaflet.markercluster.js') }}?v={{ STATIC_VERSION }}"></script>

<script src="{{ url_for('static', filename='js/page-helpers.js') }}?v={{ STATIC_VERSION }}" defer></script>
<script src="{{ url_for('static', filename='js/map.js') }}?v={{ STATIC_VERSION }}" defer></script>
{% endblock %}

</div> <!-- Close the full-width container -->
<!-- Reopen the base template's container for the footer -->
<div class="container mt-4">
